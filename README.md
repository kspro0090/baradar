# سیستم درخواست خدمات فارسی
# Persian Service Request System

یک سیستم وب‌ Flask برای مدیریت درخواست‌های خدمات با رابط کاربری فارسی و پشتیبانی از RTL.

## ویژگی‌ها

- رابط کاربری کاملاً فارسی با پشتیبانی RTL
- سیستم احراز هویت برای مدیران
- ایجاد فرم‌های پویا برای خدمات مختلف
- سیستم پیگیری درخواست‌ها
- تولید PDF از درخواست‌های تایید شده
- **جدید**: یکپارچه‌سازی با Google Docs برای مدیریت قالب‌ها
- **جدید**: پیش‌نمایش زنده محتوای Google Docs
- حفظ فرمت و RTL در PDF های تولید شده

## نصب و راه‌اندازی

### 1. نصب وابستگی‌ها

```bash
cd project
pip install -r requirements.txt
```

### 2. راه‌اندازی پایگاه داده

```bash
# روش 1: اجرای مستقیم برنامه (کاربر admin به صورت خودکار ایجاد می‌شود)
python app.py

# روش 2: استفاده از دستور Flask CLI
flask --app app.py init-db
```

### 3. پیکربندی Google Docs

```bash
# کپی فایل نمونه
cp credentials.json.example credentials.json
# فایل credentials.json را با اطلاعات واقعی service account پر کنید
```

برای راهنمای کامل به فایل `GOOGLE_DOCS_SETUP.md` مراجعه کنید.

### 4. اطلاعات ورود پیش‌فرض

- **نام کاربری**: admin
- **رمز عبور**: admin123

### 5. اجرای برنامه

```bash
python app.py
```

برنامه در آدرس http://localhost:5000 قابل دسترسی خواهد بود.

## ساختار پروژه

```
project/
├── app.py                 # فایل اصلی برنامه
├── models.py              # مدل‌های پایگاه داده
├── forms.py               # فرم‌های WTForms
├── config.py              # تنظیمات برنامه
├── requirements.txt       # وابستگی‌های Python
├── test_app.py           # اسکریپت تست
├── static/
│   ├── css/
│   │   └── style.css     # استایل‌های سفارشی
│   └── fonts/            # فونت‌های فارسی
├── templates/
│   ├── base.html         # قالب پایه
│   ├── login.html        # صفحه ورود
│   ├── admin/            # قالب‌های مدیر سیستم
│   ├── approver/         # قالب‌های مدیر تایید
│   ├── user/             # قالب‌های کاربر عادی
│   └── errors/           # صفحات خطا
├── uploads/
│   ├── docx_templates/   # قالب‌های Word
│   └── user_requests/    # درخواست‌های کاربران
└── pdf_outputs/          # فایل‌های PDF تولید شده
```

## نحوه استفاده

### برای مدیر سیستم:

1. با اطلاعات admin وارد شوید
2. از داشبورد مدیر می‌توانید:
   - خدمات جدید ایجاد کنید
   - فیلدهای فرم را تعریف کنید
   - مدیران تایید جدید ایجاد کنید
   - فونت‌های فارسی آپلود کنید
   - آمار خدمات را مشاهده کنید

#### پیش‌نمایش قالب Word:
هنگام ایجاد یا ویرایش خدمت، با انتخاب فایل Word:
- محتوای سند (تا ۵ پاراگراف) نمایش داده می‌شود
- متغیرهای موجود (مثل {{NAME}}) شناسایی و نمایش داده می‌شوند
- متن فارسی با جهت RTL صحیح نمایش داده می‌شود
- بدون نیاز به ذخیره فرم، پیش‌نمایش به صورت آنی انجام می‌شود

### برای کاربران عادی:

1. از صفحه اصلی، خدمت مورد نظر را انتخاب کنید
2. فرم درخواست را پر کنید
3. کد پیگیری دریافت کنید
4. با کد پیگیری، وضعیت درخواست خود را بررسی کنید
5. پس از تایید، فایل PDF را دانلود کنید

### برای مدیران تایید:

1. با اطلاعات کاربری خود وارد شوید
2. درخواست‌های در انتظار را بررسی کنید
3. درخواست‌ها را تایید یا رد کنید

## تست سیستم

برای تست صحت عملکرد سیستم:

```bash
python test_app.py
```

## نکات مهم

1. **فونت‌های فارسی**: برای تولید صحیح PDF فارسی، حتماً یک فونت فارسی (TTF یا OTF) آپلود کنید و آن را به عنوان پیش‌فرض انتخاب کنید.

2. **قالب‌های Word**: در قالب‌های Word، از placeholder هایی مثل `{{NAME}}` استفاده کنید که با مقادیر فرم جایگزین می‌شوند.

3. **امنیت**: در محیط production، حتماً:
   - SECRET_KEY را تغییر دهید
   - از HTTPS استفاده کنید
   - رمز عبور admin را تغییر دهید

## رفع مشکلات رایج

### مشکل: نمی‌توانم با admin/admin123 وارد شوم
```bash
flask --app app.py init-db
```

### مشکل: خطای Jinja2 در قالب‌ها
مطمئن شوید که از `{{ variable }}` استفاده می‌کنید، نه `{{{{ variable }}}}`

### مشکل: PDF فارسی به درستی نمایش داده نمی‌شود (مربع‌های سیاه)

این مشکل به دلیل عدم وجود فونت فارسی مناسب است. برای رفع آن:

#### روش سریع: استفاده از فونت نمونه
```bash
python3 add_sample_font.py
```
این دستور فونت Vazir را دانلود و به عنوان فونت پیش‌فرض تنظیم می‌کند.

#### روش دستی: آپلود فونت از پنل مدیریت
1. وارد پنل مدیر سیستم شوید
2. به بخش "مدیریت فونت‌ها" بروید
3. یک فونت فارسی (TTF یا OTF) آپلود کنید
4. گزینه "فونت پیش‌فرض" را تیک بزنید
5. ذخیره کنید

#### تست عملکرد PDF
```bash
python3 test_pdf_generation.py
```
این دستور یک PDF تست با متن فارسی تولید می‌کند.

### مشکل: خطای import در اجرای برنامه
```bash
pip install -r requirements.txt
```

## مجوز

این پروژه تحت مجوز MIT منتشر شده است.