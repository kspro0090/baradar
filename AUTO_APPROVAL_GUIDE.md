# راهنمای سیستم تأیید خودکار

## خلاصه

این سیستم امکان تأیید خودکار درخواست‌ها را بر اساس لیست پرسنل در Google Sheet فراهم می‌کند. همچنین از یک صف برای پردازش PDF استفاده می‌کند تا از تداخل در تولید همزمان جلوگیری شود.

## ویژگی‌های کلیدی

### 1. تأیید خودکار
- ✅ بررسی خودکار نام کاربر با لیست Google Sheet
- ✅ تأیید فوری درخواست‌های کارمندان مجاز
- ✅ تولید PDF به صورت خودکار
- ✅ قابل تنظیم برای هر خدمت

### 2. مدیریت صف
- ✅ پردازش ترتیبی درخواست‌ها
- ✅ جلوگیری از تداخل در تولید PDF
- ✅ امکان retry در صورت خطا
- ✅ callback برای اطلاع از وضعیت

### 3. انعطاف‌پذیری
- ✅ امکان تعیین Google Sheet مختلف برای هر خدمت
- ✅ انتخاب ستون و فیلد مورد بررسی
- ✅ غیرفعال‌سازی برای خدمات خاص

## نحوه راه‌اندازی

### 1. اجرای Migration

```bash
python migrations/add_auto_approval_fields.py
```

### 2. به‌روزرسانی Google Sheet

مطمئن شوید که Google Sheet با ID زیر شامل لیست پرسنل است:
```
1qqmTsIfLwGVPVj7kHnvb3AvAdFcMw37dh0RCoBxYViQ
```

در ستون A، نام کارمندان را وارد کنید:
```
علی محمدی
سارا احمدی
محمد رضایی
فاطمه زارعی
...
```

### 3. اشتراک‌گذاری Google Sheet

Google Sheet را با service account به اشتراک بگذارید (دسترسی Viewer کافی است).

## استفاده در سیستم

### 1. ایجاد خدمت جدید

هنگام ایجاد خدمت جدید:
1. گزینه "تأیید خودکار بر اساس لیست پرسنل" را تیک بزنید
2. در صورت نیاز، Google Sheet ID را تغییر دهید
3. ستون مورد نظر را مشخص کنید (پیش‌فرض: A)
4. پس از تعریف فیلدها، فیلد مورد بررسی را انتخاب کنید

### 2. ویرایش خدمت موجود

در صفحه ویرایش خدمت:
1. بخش "تنظیمات تأیید خودکار" را باز کنید
2. تنظیمات را مطابق نیاز تغییر دهید
3. فیلد مورد بررسی را از لیست انتخاب کنید

### 3. فرآیند تأیید خودکار

وقتی کاربر درخواست ثبت می‌کند:
1. سیستم مقدار فیلد انتخابی را استخراج می‌کند
2. با لیست Google Sheet مقایسه می‌کند (case-insensitive)
3. در صورت وجود:
   - درخواست تأیید می‌شود
   - PDF در صف تولید قرار می‌گیرد
   - کاربر پیام تأیید دریافت می‌کند
4. در صورت عدم وجود:
   - روند عادی (تأیید دستی) ادامه می‌یابد

## معماری فنی

### کامپوننت‌ها

1. **`google_sheets_checker.py`**
   - بررسی مقادیر در Google Sheet
   - کش کردن داده‌ها برای بهبود عملکرد
   - مقایسه case-insensitive

2. **`pdf_queue_processor.py`**
   - مدیریت صف تولید PDF
   - پردازش ترتیبی
   - مدیریت خطا و retry

3. **تغییرات در `app.py`**
   - منطق تأیید خودکار در `request_service`
   - استفاده از صف در `review_request`

4. **تغییرات در `models.py`**
   - فیلدهای جدید در مدل Service
   - `auto_approve_enabled`
   - `auto_approve_sheet_id`
   - `auto_approve_sheet_column`
   - `auto_approve_field_name`

### فرآیند صف

```python
# اضافه کردن به صف
task_id = add_pdf_task(service_request, callback=on_complete)

# بررسی وضعیت
task = get_task_status(task_id)

# انتظار برای تکمیل
task = wait_for_task(task_id, timeout=30)
```

## تست سیستم

برای تست کامل سیستم:

```bash
python test_auto_approval.py
```

این تست‌ها را انجام می‌دهد:
1. بررسی اتصال به Google Sheet
2. تست عملکرد صف
3. شبیه‌سازی فرآیند تأیید خودکار

## رفع مشکلات

### خطا: "credentials.json not found"
فایل credentials.json را از Google Cloud Console دانلود کنید.

### خطا: "Permission denied" برای Google Sheet
- Google Sheet را با service account به اشتراک بگذارید
- دسترسی Viewer کافی است

### تأیید خودکار کار نمی‌کند
1. بررسی کنید که تنظیمات فعال باشد
2. فیلد مورد بررسی انتخاب شده باشد
3. مقدار دقیقاً در Google Sheet موجود باشد
4. لاگ‌ها را بررسی کنید

### PDF تولید نمی‌شود
1. وضعیت صف را بررسی کنید
2. Google Docs ID معتبر باشد
3. دسترسی‌های لازم وجود داشته باشد

## نکات امنیتی

1. **محدودیت دسترسی**: فقط مدیران سیستم می‌توانند تنظیمات تأیید خودکار را تغییر دهند
2. **اعتبارسنجی**: همیشه مقادیر با trim و lowercase مقایسه می‌شوند
3. **لاگ**: تمام تأییدهای خودکار در لاگ ثبت می‌شوند
4. **Fallback**: در صورت خطا، سیستم به حالت تأیید دستی برمی‌گردد

## مثال عملی

### سناریو: درخواست مرخصی با تأیید خودکار

1. **تنظیم خدمت**:
   - نام: درخواست مرخصی
   - تأیید خودکار: فعال
   - فیلد بررسی: employee_name

2. **ثبت درخواست**:
   - کاربر: علی محمدی
   - نوع مرخصی: استحقاقی
   - تاریخ: 1402/12/01

3. **پردازش**:
   - سیستم "علی محمدی" را در Google Sheet پیدا می‌کند
   - درخواست تأیید می‌شود
   - PDF در صف قرار می‌گیرد
   - پس از تولید، در پروفایل کاربر قابل دانلود است

## نتیجه

این سیستم فرآیند تأیید را برای کارمندان شناخته‌شده خودکار می‌کند و در عین حال انعطاف کافی برای موارد خاص را حفظ می‌کند. استفاده از صف تضمین می‌کند که تولید PDF ها به صورت منظم و بدون تداخل انجام شود.